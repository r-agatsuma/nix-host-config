name: 'Update Flake Lock'

on:
  workflow_dispatch: # 手動実行
  schedule:
    # 毎週日曜 AM 3:00 (UTC)
    - cron: '0 3 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  autoupdate:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Set current datetime as env variable
        env:
          TZ: 'Asia/Tokyo' # タイムゾーン指定
        run: echo "CURRENT_DATETIME=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: 'Install Nix (Flakes enabled)'
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: 'Update flake lock'
        run: nix flake update

      - name: 'Run build test for ci-test configuration'
        run: |
          echo "Attempting to build target: .#nixosConfigurations.ci-test.config.system.build.toplevel"
          nix build .#nixosConfigurations.ci-test.config.system.build.toplevel
      
      - name: 'Create Pull Request'
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          title: 'ci(deps): Update flake.lock'
          commit-message: |
            ci(deps): Update flake.lock

            Automated update of 'flake.lock' by GitHub Actions.
          branch: 'ci/update-flake-lock-at-${{ env.CURRENT_DATETIME }}'
          delete-branch: true
          add-paths: |
            flake.lock